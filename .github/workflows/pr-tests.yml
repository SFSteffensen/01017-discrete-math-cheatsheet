name: PR Tests & Function Coverage

on:
  pull_request:
    branches:
      - main

jobs:
  check-test-coverage:
    name: Check Test Coverage for Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check that new functions have tests
        run: |
          echo "üîç Checking test coverage for Typst functions..."

          # Extract function names from main file (matches #let function-name(...) = {)
          # This pattern looks for functions (with parentheses), not simple variable assignments
          ALL_FUNCTIONS=$(grep -oE '#let [a-zA-Z_-]+\(' Discrete_Cheat_Sheet.typ | \
                          sed 's/#let //' | sed 's/($//' | sort -u)

          # Separate display functions (show-*) from computational functions
          # Display functions are excluded from mandatory test coverage
          DISPLAY_FUNCTIONS=$(echo "$ALL_FUNCTIONS" | grep -E '^show-' || true)
          MAIN_FUNCTIONS=$(echo "$ALL_FUNCTIONS" | grep -vE '^show-' || true)

          echo "üìã Computational functions (tests REQUIRED):"
          echo "$MAIN_FUNCTIONS" | while read -r func; do
            [ -n "$func" ] && echo "  - $func"
          done

          echo ""
          echo "üé® Display functions (tests optional, excluded from check):"
          echo "$DISPLAY_FUNCTIONS" | while read -r func; do
            [ -n "$func" ] && echo "  - $func"
          done
          echo ""

          # Check each computational function has at least one test
          MISSING_TESTS=""
          TESTED_COUNT=0
          TOTAL_COUNT=0

          for func in $MAIN_FUNCTIONS; do
            [ -z "$func" ] && continue
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            # Look for the function being called in tests.typ (function-name( pattern)
            # Also check for function definitions in test file
            if grep -qE "(${func}\(|#let.*${func})" tests.typ; then
              TESTED_COUNT=$((TESTED_COUNT + 1))
              echo "‚úÖ $func - has tests"
            else
              MISSING_TESTS="$MISSING_TESTS $func"
              echo "‚ùå $func - MISSING TESTS"
            fi
          done

          echo ""
          echo "üìä Coverage: $TESTED_COUNT / $TOTAL_COUNT computational functions have tests"

          if [ -n "$MISSING_TESTS" ]; then
            echo ""
            echo "‚ùå ERROR: The following functions are missing test coverage:"
            for func in $MISSING_TESTS; do
              echo "  - $func"
            done
            echo ""
            echo "Please add tests for these functions in tests.typ before merging."
            echo "(Note: show-* display functions are excluded from this requirement)"
            exit 1
          fi

          echo ""
          echo "‚úÖ All computational functions have test coverage!"

  run-tests:
    name: Run Typst Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: "latest"

      - name: Run test suite
        run: |
          echo "üß™ Running Typst test suite..."
          typst compile "tests.typ" "/tmp/tests.pdf"
          echo "‚úÖ All tests passed!"
        env:
          TYPST_PACKAGE_PATH: ${{ github.workspace }}/packages

      - name: Verify main document compiles
        run: |
          echo "üìÑ Compiling main document..."
          typst compile "Discrete_Cheat_Sheet.typ" "/tmp/cheatsheet.pdf"
          echo "‚úÖ Main document compiled successfully!"
        env:
          TYPST_PACKAGE_PATH: ${{ github.workspace }}/packages
